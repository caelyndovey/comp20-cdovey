<!DOCTYPE html>
<html>

    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <link rel="stylesheet" href="style.css" type="text/css" />
        <meta charset="utf-8">
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk"></script>

        <script>
            var map;
            var rideRequests;
            var myLat = 0;
            var myLng = 0;
            var me = new google.maps.LatLng(myLat, myLng);
            var myIcon = {
                url: "manatee.jpg",
                scaledSize: new google.maps.Size(40, 40)
            }
            var passengerIcon = {
                url: "passenger.png",
                scaledSize: new google.maps.Size(40, 40)
            }
            var weinermobileIcon = {
                url: "weinermobile.png",
            }
            var driverIcon = {
                url: "car.png",
            }
            var marker;
            var infowindow = new google.maps.InfoWindow();

            function init() {
                getLocation();
            }

            function getLocation() {
                navigator.geolocation.getCurrentPosition(function(position) { 
                    myLat = position.coords.latitude;
                    myLng = position.coords.longitude;
                    // myLat = 42.418560 
                    // myLng = -71.106453 
                    initMap();
                });
            }

            function initMap() {
                me = new google.maps.LatLng(myLat, myLng);
                map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: myLat, lng: myLng},
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoom: 8 });
                marker = new google.maps.Marker({
                    position: me,
                    icon: myIcon,
                    title: "my username here"
                });
                marker.setMap(map);

                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(marker.title);
                    infowindow.open(map, marker);
                });
                getRides();
            }

            function getRides() {
                var request = new XMLHttpRequest();
                var url = 'https://hans-moleman.herokuapp.com/rides';
                var params = 'username=FQ4DubnJ&lat='+myLat+'&lng='+myLng;
        
                request.open('POST', url, true);
                request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        rideRequests = JSON.parse(request.responseText);

                        if ((Object.keys(rideRequests)[0]) == "vehicles") 
                            placeVehicles();
                        else
                            placePassengers();
                    }
                }
                request.send(params); 
            }

            function placeVehicles() {
                var cur_icon = driverIcon;
                for (i = 0; i < (rideRequests.vehicles.length); i++) {
                    if (rideRequests.vehicles[i].username == "WEINERMOBILE")
                        cur_icon = weinermobileIcon;
                    marker = new google.maps.Marker ({
                        position: new google.maps.LatLng(rideRequests.vehicles[i].lat, rideRequests.vehicles[i].lng),
                        icon: cur_icon,
                        title: "my username here"
                        });
                    marker.setMap(map);
                }
            }

            function placePassengers() {
                for (i = 0; i < (rideRequests.passengers.length); i++) {
                    marker = new google.maps.Marker ({
                        position: new google.maps.LatLng(rideRequests.passengers[i].lat, 
                                  rideRequests.passengers[i].lng),
                        icon: passengerIcon,
                        title: "my username here"
                        });
                    marker.setMap(map);
                }


            }
        
        </script>
    </head>

    <body onload="init()">
        <div id="map"></div>
    </body>

</html>